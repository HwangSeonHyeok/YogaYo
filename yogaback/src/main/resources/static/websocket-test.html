<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>STOMP WebSocket Test</title>
  <!-- CDN을 통해 stomp.js 로드 -->
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs"></script>
</head>
<body>
  <h1>STOMP WebSocket Test</h1>
  
  <div>
    <label for="token">JWT Token:</label>
    <input type="text" id="token" style="width: 300px;">
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn">Disconnect</button>
  </div>
  
  <div>
    <label for="roomId">Room ID:</label>
    <input type="text" id="roomId" value="room123">
    <button id="subscribeBtn">Subscribe to Room</button>
  </div>
  
  <div>
    <label for="action">Action:</label>
    <select id="action">
      <option value="enter">Enter Room</option>
      <option value="ready">Ready</option>
      <option value="signal">Signal</option>
      <option value="iceCandidate">ICE Candidate</option>
      <option value="heartbeat">Heartbeat</option>
    </select>
  </div>
  
  <div>
    <label for="messageInput">Message:</label>
    <input type="text" id="messageInput">
    <button id="sendBtn">Send Message</button>
  </div>
  
  <pre id="output" style="border:1px solid #ccc; padding:10px; width:80%; height:200px; overflow:auto;"></pre>
  
  <script>
    // stomp.js 클라이언트 변수
    let client = null;
    let connected = false;
    let heartbeatInterval = null;
    let lastMessageTime = null;
    const HEARTBEAT_INTERVAL = 30000; // 30초마다 heartbeat 전송
    const CONNECTION_TIMEOUT = 60000; // 60초 동안 메시지가 없으면 연결 해제
    
    // 마지막 메시지 시간 업데이트
    function updateLastMessageTime() {
      lastMessageTime = Date.now();
    }
    
    // 연결 상태 체크
    function checkConnection() {
      if (connected && lastMessageTime) {
        const timeSinceLastMessage = Date.now() - lastMessageTime;
        if (timeSinceLastMessage > CONNECTION_TIMEOUT) {
          document.getElementById("output").textContent += "No message received for " + (CONNECTION_TIMEOUT/1000) + " seconds. Disconnecting...\n";
          if (client) {
            client.deactivate();
            connected = false;
          }
        }
      }
    }
    
    // Heartbeat 전송
    function sendHeartbeat(roomId) {
      if (client && connected) {
        const payload = {
          action: "heartbeat",
          message: {}
        };
        
        client.publish({
          destination: "/app/action/" + roomId,
          body: JSON.stringify(payload)
        });
        document.getElementById("output").textContent += "Sent heartbeat\n";
      }
    }
    
    // 연결 버튼 클릭 시 동작
    document.getElementById('connectBtn').addEventListener('click', function() {
      const token = document.getElementById('token').value;
      if (!token) {
        alert('Please enter a JWT token');
        return;
      }

      client = new StompJs.Client({
        brokerURL: "wss://j12d104.p.ssafy.io/ws",
        connectHeaders: {
          'token': token
        },
        reconnectDelay: 5000, // 재연결 딜레이 (ms)
        debug: function(str) {
          console.log(str);
          document.getElementById("output").textContent += str + "\n";
        }
      });
      
      // 연결 성공 시 처리
      client.onConnect = function(frame) {
        connected = true;
        lastMessageTime = Date.now();
        document.getElementById("output").textContent += "Connected: " + frame + "\n";
        
        // Heartbeat 인터벌 시작
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }
        heartbeatInterval = setInterval(() => {
          const roomId = document.getElementById('roomId').value;
          sendHeartbeat(roomId);
        }, HEARTBEAT_INTERVAL);
      };
      
      // STOMP 에러 발생 시 처리
      client.onStompError = function(frame) {
        document.getElementById("output").textContent += "Broker error: " + frame.headers['message'] + "\n" + frame.body + "\n";
      };
      
      client.activate();
    });
    
    // 연결 종료 버튼 클릭 시 동작
    document.getElementById('disconnectBtn').addEventListener('click', function() {
      if(client && connected){
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
          heartbeatInterval = null;
        }
        client.deactivate();
        connected = false;
        document.getElementById("output").textContent += "Disconnected\n";
      }
    });
    
    // 구독 버튼 클릭 시 동작
    document.getElementById('subscribeBtn').addEventListener('click', function() {
      if(client && connected){
        let roomId = document.getElementById('roomId').value;
        // 구독할 토픽들
        const topics = [
          "/topic/room/" + roomId,
          "/topic/room/" + roomId + "/allReady",
          "/topic/room/" + roomId + "/courseStarted",
          "/topic/room/" + roomId + "/userReady",
          "/topic/room/" + roomId + "/signal",
          "/topic/room/" + roomId + "/iceCandidate",
          "/topic/room/" + roomId + "/heartbeat",
          "/user/queue/errors"
        ];
        
        topics.forEach(topic => {
          client.subscribe(topic, function(message) {
            updateLastMessageTime();
            document.getElementById("output").textContent += "Received from " + topic + ": " + message.body + "\n";
          });
          document.getElementById("output").textContent += "Subscribed to " + topic + "\n";
        });
      }
    });
    
    // 메시지 전송 버튼 클릭 시 동작
    document.getElementById('sendBtn').addEventListener('click', function() {
      if(client && connected){
        let roomId = document.getElementById('roomId').value;
        let action = document.getElementById('action').value;
        let messageInput = document.getElementById('messageInput').value;
        
        let payload = {
          action: action,
          message: {}
        };
        
        // 액션별 메시지 포맷 설정
        switch(action) {
          case "enter":
            payload.message = {
              roomId: roomId,
              userId: "1", // JWT 토큰에서 추출된 값으로 대체되어야 함
              userNickName: "Tester",
              userProfile: "profileUrl"
            };
            break;
          case "ready":
            payload.message = {
              ready: true
            };
            break;
          case "signal":
            payload.message = {
              signal: messageInput
            };
            break;
          case "iceCandidate":
            payload.message = {
              candidate: messageInput
            };
            break;
          case "heartbeat":
            payload.message = {};
            break;
        }
        
        client.publish({
          destination: "/app/action/" + roomId,
          body: JSON.stringify(payload)
        });
        updateLastMessageTime();
        document.getElementById("output").textContent += "Sent: " + JSON.stringify(payload) + "\n";
      }
    });

    // 주기적으로 연결 상태 체크
    setInterval(checkConnection, 10000); // 10초마다 체크
  </script>
</body>
</html>
